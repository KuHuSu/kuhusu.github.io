#### **TCP/IP协议**

本地应用程序跟远程节点中的应用程序数据通信，需要使用到网络服务。数据从本地应用到网络，总共经过以下层次：

- **应用层：**应用程序直接产生数据的位置，这一层是在用户态产生；
- **传输层：**应用层产生的数据发送到该层后，该层会在原始数据的基础上增加一个TCP头部，主要用于标志发送方端口，接收方端口等信息。**传输层并不直接负责传输**。传输层会将应用层传递来的数据分段，确保实际数据长度小于等于能传输的最大数据长度。TCP头部最少长度为20字节，最大为60字节，其中40字节为可选空间。
- **网络层：**网络层会在传输层传递的数据包前添加网络寻址信息，即对端的IP信息等，主要用于网络包在网络中寻址。IPV4中IP头最少20字节，最大60字节，其中40字节为可选空间。IPV6中固定长度为40字节。
- **网络接口层：**该层接收上一层的数据包，并添加帧头和帧尾组成一个数据帧，同时还需要添加上设备的MAC地址，用于定位设备在网络域中的位置。

一个完整的包含：MAC头，IP头，TCP头部，以及数据；

在MAC协议中：一般结构为：先导码，帧起始定位，以太网头部（6+6+2），数据，帧结尾

其中额以太网头部包含目标MAC，源MAC以及TCP协议类型。

wireshark软件捕获的数据包不包含帧头帧尾，先导码以及帧头帧尾在物理网卡层就已经被过滤掉了，展现给用户的是中间纯净的数据。

#### Mac层协议结构

经典的Mac协议：

| 前导码       | 目的地址 | 源地址 | 类型（或长度） | 数据       | 填充     | 校验和 |
| ------------ | -------- | ------ | -------------- | ---------- | -------- | ------ |
| 8字节(或7+1) | 6字节    | 6字节  | 2字节          | 0~1500字节 | 0~46字节 | 4字节  |

- 前导码格式固定，其中包含帧头SOF，即11。这个数据通常由网卡驱动直接处理；
- 目的地址和源地址：这两个地址指的是设备的物理地址，其中如果目的地址的第一位是0，则表示这个是普通的设备地址；如果是1，则表示这是一个**组播地址**，该帧需要传递到组中的所有站点；如果整个目的地址全是1，则表示这是一个**广播地址**，所有站点都需要接收消息；
- 类型或者长度：后续数据的最长为1500字节，当该处的值小于等于1500时，表示的即为数据长度，当该处的值大于1500时，则表示接收端需要采用哪种解析协议处理该帧；**如果是类型，则表示这里的数据应该交给哪个协议来处理，也就是其上一层网络层是哪个协议，比如指定协议为IPV4，则该位应该为0800；**

#### IP层协议结构

IPV4协议头部：

<table>
  <tr>
    <th align="center">协议版本+头长度</th>
    <th align="center">区分服务</th>
    <th colspan = "2" align="center">数据总长度</th>
  </tr>
  <tr>
    <th align="center" colspan = "2">标志属于哪个报文</th>
    <th align="center" colspan = "2">3+13，13位表示分段偏移量</th>
  </tr>
  <tr>
    <th align="center">生存期</th>
    <th align="center">协议</th>
    <th colspan = "2" align="center">头校验和</th>
  </tr>
  <tr>
    <th colspan = "4" align="center">源地址(IP)</th>
  </tr>
  <tr>
    <th colspan = "4" align="center">目标地址(IP)</th>
  </tr>
  <tr>
    <th colspan = "4" align="center">保留空间(40字节)</th>
  </tr>
</table>

- 协议版本+头长度：协议版本占1字节，表示所采用的，头长度占1字节。**这里的协议指的是当前头部所采用的协议，这里值应该为4，表示 IPV4协议；**后续1字节的长度表示的是该头部的长度(不是总数据)，因为IPV4协议最短20字节，最长60，不确定，所以需要指定长度，但是这个指定的**长度单位并不是字节，而是“4字节”**，比如如果值为5，则表示5*4=20字节。
- 区分服务：；
- 数据总长度：**单位为字节**，表示IP数据包的总长度，单指IP数据包，不包含外层的Mac协议头。
- 分段偏移量：表示该分段在整个数据报文中属于第几段，用于乱序拼凑。只有13位长度，因此最大支持的长度为$2^{13}$段；
- 生存期：避免段一直在网络中阻塞；
- 协议：**这里这个协议指的是该段的数据应该使用哪种传输层协议处理，比如指定06，则表示TCP协议**；
- 头校验和：校验。
- 源地址/目标地址：IPV4，这里指的4字节的IP地址；

#### TCP层协议

常用TCP头协议：

<table>
  <tr>
    <th colspan = "2" align="center">源端口</th>
    <th colspan = "2" align="center">目的端口</th>
  </tr>
  <tr>
    <th align="center" colspan = "4">序号</th>
  </tr>
  <tr>
    <th colspan = "4" align="center">确认号</th>
  </tr>
  <tr>
    <th colspan = "2" align="center">头长度+段的拥塞控制</th>
    <th colspan = "2" align="center">窗口大小</th>
  </tr>
  <tr>
    <th colspan = "2" align="center">校验和</th>
    <th colspan = "2" align="center">紧急指针</th>
  </tr>
  <tr>
    <th colspan = "4" align="center">保留空间</th>
  </tr>
    <tr>
    <th colspan = "4" align="center">数据</th>
  </tr>
</table>

- 源端口/目的端口：均为2字节的数据，最大表示65535，也就是端口大小的上限值；
- 序号和确认号：用于表示当前段是TCP流中第几个，确认号则表示后续希望收到的序号；
- 头长度：**单位为“4字节”**；
- 拥塞控制字符：包含8个，每个均只有1位空间，包含常用的ACK,RST,FIN等；
- 紧急指针：如果需要紧急中断某个信息的处理，比如Ctrl+C中断。该16位的空间表示从当前段找到所要紧急处理的段的序号偏移量。
- 保留空间：40字节的保留空间；
- 数据：可为空。

#### 综合

- Mac，IP以及TCP每一层都有单独的校验位；
- Mac负责物理地址，IP负责网络地址，TCP负责进程地址(端口号)；
- 一个最短的网络数据包应该为：8+6+6+20+20 = 60 （不包含帧头帧尾）
- 这是一个完整的数据包，通过以上内容可以找到其中的各种信息：

![image-20260202194709925](C:\Users\18385\AppData\Roaming\Typora\typora-user-images\image-20260202194709925.png)

#### 浏览器

网址的含义：

![image-20260202194903103](C:\Users\18385\AppData\Roaming\Typora\typora-user-images\image-20260202194903103.png)

#### 输入网址->返回界面流程：

**本地会执行：**

- 用户输入网址；
- 浏览器查询缓存的DNS服务，找对应的IP地址；如果找不到就去问DNS服务器要；
- 得到服务名对应的IP地址，结合请求数据，请求头，组成一个HTTP请求包；
- 浏览器http进程将HTTP请求包通过一些接口，交给操作系统；
- 操作系统根据本地进程以及请求目的地进程，确定源端口和目标端口(这个端口http请求网址中显式给出，或者默认80/443)，**用于指定对端具体的某个服务进程**；
- TCP三次握手，确保对端能接收到本地的数据，以及确保本地能接收到对端的数据；
- 组成TCP头部，添加到http请求头部；
- （如果http请求包太长，会将请求包分割，每个依次添加TCP头，序号递增）；
- 以上包再传递给IP层，该层会将本地IP和目的IP写进IP头部中，**用于指定对端的唯一地址**；
- 以上包再传递给Mac层，这一层需要添加本地网卡的Mac地址；
- 首先该层会查看本地ARP缓存中是否有下一个节点的Mac地址，没有则使用ARP服务获取**下一个节点的Mac地址**，**用于局部的点对点数据传输**；
- 包含Mac头，IP头，TCP头，HTTP头的数据包被打包发给网卡。网卡驱动将数字信号转化为电信号开启传输；

**网络中执行：**

- 交换机收到发送而来的包，按照指定的Mac地址将数据转发给下一个节点(可能是路由器，也可能是目的地)；
- 假如是路由器。路由器收到数据包后，当前的目的Mac已经完成任务，抹除。并继续使用ARP服务获取通往目标IP的下一个节点的Mac地址，填入到目的Mac中，发送给交换机，或者下一个路由器；
- （如果使用IPv4，很多路由器中还有一个NAT服务，将源IP转换为公网IP。因为公网IP已经耗尽，需要通过NAT服务实现多个私网共用。也可能是网络传输的过程中会单独出现一个NAT服务专门负责转换这个IP地址。）
- 不断重复以上流程，直到数据包到达指定的设备中；

**对端执行：**

- 对端网卡收到数据包，比对目的Mac和自己的Mac，两者匹配，将数据收入；
- 网卡驱动将电信号转化为数字信号，并核对校验和；
- 操作系统解包IP头部，发现是自己的IP，继续交给下一层；
- 操作系统解包TCP头部，找到其目标端口12345，而该端口上确实存在一个监听进程，于是将数据给到该进程；
- 该进程解析HTTP包，并组织其所需要的内容，比如一个html文件；
- 进程将所需内容组织，并打包为一个HTTP数据包，交给操作系统；
- 操作系统依次添加TCP头，IP头，Mac头(下一个节点的Mac)，最后交给网卡；
- 网卡将数据发出；

**最后本地执行：**

- 同上一样的流程，最终我的浏览器的某个标签页进程收到了数据包，浏览器解析数据包并呈现出界面或者文件数据；

**总结：**

- Mac地址用于最根本的的数据传输，也就是最底层的点对点传输，只关注局部的两个点之间的传输；
- IP地址和端口号都是用于匹配本地和最终目的地的对应数据载体；
- Mac目标地址在传输中会不断发生改变，以实现不断地点对点传输；
- **IP目标地址不会发生变化，而IP源地址理论上不会发生变化，但是实际应用中会变化**。
  - IP地址只有32位，总计约43亿，除去私网IP以及一些不可使用地IP外，可用IP数量约37亿；
  - 这个地址长度在设计之初并没考虑到这么多的设备，目前已经耗尽；
  - 为了解决这个问题，出现了NAT服务，网络地址转换，其拥有一个公网IP，并负责转发几百几千几万个私网IP向公网地数据请求；
  - 甚至包含多级NAT，底层NAT负责将私网IP转换为另外一个私网IP，最顶层NAT才负责将私网IP转换为公网IP；
  - NAT相当于数据转发，私网设备向公网某服务请求数据，需要委托NAT发送；
  - 为解决IPv4耗尽的问题，设计了IPv6，总计128位地址，完全够用；

**补充：**

- HTTPS：现代网络中绝大多数的请求都是通过https协议打包的。该协议在本地与服务器发送请求之前，进行一次通信，本次同行会约定两者之间的加密格式，以及验证信息。称为TLS。本地与服务器通过验证后，会将http报文加密再发送，这样避免了数据包被中途拦截的安全风险。
- 负载均衡器：现在访问很多服务并不是直接访问其具体的某个服务器，而是访问到一个**负载均衡服务器**，该服务器会根据算法将请求均衡分配到多个服务器中处理（比如**一致性哈希算法**）。

